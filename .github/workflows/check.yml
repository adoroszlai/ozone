# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: ci-check

on:
  workflow_call:
    inputs:
      # REQUIRED
      script:
        type: string
        description: Test script to run from hadoop-ozone/dev-support/checks, without .sh extension
        required: true

      sha:
        type: string
        description: Commit SHA
        required: true

      # OPTIONAL
      artifact-name:
        type: string
        description: "Name of artifact to upload (default: value of input script)"
        default: ''
        required: false

      checkout-fetch-depth:
        type: int
        description: Fetch depth for checking out the repo
        default: 1
        required: false

      java-version:
        type: int
        description: Java version to set up
        required: false

      needs-maven-repo:
        type: boolean
        description: Whether to restore Maven cache before run
        default: false
        required: false

      needs-ozone-binary-tarball:
        type: boolean
        description: Whether to download Ozone binary tarball created by build
        default: false
        required: false

      needs-ozone-repo:
        type: boolean
        description: Whether to download Ozone jars created by build
        default: false
        required: false

      needs-ozone-source-tarball:
        type: boolean
        description: Whether to download Ozone source tarball created by build
        default: false
        required: false

      pre-script:
        type: string
        description: Command to execute before the test script
        default: ''
        required: false

      post-failure:
        type: string
        description: Command to execute after the test script failed
        default: ''
        required: false

      post-success:
        type: string
        description: Command to execute after the test script succeeded
        default: ''
        required: false

      ratis-args:
        type: string
        description: Version overrides from custom Ratis build
        default: ''
        required: false

      runner:
        type: string
        description: GitHub Actions runner to use
        default: 'ubuntu-20.04'
        required: false

      script-args:
        type: string
        description: Arguments for the test script
        default: ''
        required: false

      timeout-minutes:
        type: int
        description: Job timeout in minutes
        default: 30
        required: false

      with-coverage:
        type: boolean
        description: Set OZONE_WITH_COVERAGE
        default: true
        required: false

jobs:
  check:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Checkout project
        if: ${{ !inputs.needs-ozone-source-tarball }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}
          fetch-depth: ${{ inputs.checkout-fetch-depth }}

      - name: Download Ozone source tarball
        if: ${{ inputs.needs-ozone-source-tarball }}
        uses: actions/download-artifact@v4
        with:
          name: ozone-src

      - name: Extract source tarball
        if: ${{ inputs.needs-ozone-source-tarball }}
        run: |
          tar --strip-components 1 -xzvf ozone*-src.tar.gz

      - name: Cache for maven dependencies
        if: ${{ inputs.needs-maven-cache }}
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.m2/repository/*/*/*
            !~/.m2/repository/org/apache/ozone
          key: maven-repo-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-repo-

      - name: Download Ozone repo
        id: download-ozone-repo
        if: ${{ inputs.needs-ozone-repo }}
        uses: actions/download-artifact@v4
        with:
          name: ozone-repo
          path: |
            ~/.m2/repository/org/apache/ozone

      - name: Download Ratis repo
        if: ${{ inputs.ratis-args != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ratis-jars
          path: |
            ~/.m2/repository/org/apache/ratis

      - name: Download Ozone binary tarball
        if: ${{ inputs.needs-ozone-binary-tarball }}
        uses: actions/download-artifact@v4
        with:
          name: ozone-bin

      - name: Extract binary tarball
        if: ${{ inputs.needs-ozone-binary-tarball }}
        run: |
          mkdir -p hadoop-ozone/dist/target
          tar xzvf ozone*.tar.gz -C hadoop-ozone/dist/target
          rm ozone*.tar.gz

      - name: Setup java ${{ inputs.java-version }}
        if: ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}

      - name: Execute pre-test steps
        if: ${{ inputs.pre-script }}
        run: |
          ${{ inputs.pre-script }}

      - name: Execute tests
        run: |
          hadoop-ozone/dev-support/checks/${{ inputs.script }}.sh ${{ inputs.script-args }} ${{ inputs.ratis-args }}
        env:
          DEVELOCITY_ACCESS_KEY: ${{ secrets.GE_ACCESS_TOKEN }}
          OZONE_WITH_COVERAGE: ${{ inputs.with-coverage }}

      - name: Execute post-failure steps
        if: ${{ failure() && inputs.post-failure }}
        run: |
          ${{ inputs.post-failure }}

      - name: Execute post-success steps
        if: ${{ !failure() && inputs.post-success }}
        run: |
          ${{ inputs.post-success }}

      - name: Summary of failures
        if: ${{ !cancelled() }}
        run: |
          hadoop-ozone/dev-support/checks/_summary.sh target/${{ inputs.script }}/summary.txt

      - name: Archive build results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name || inputs.script }}
          path: target/${{ inputs.script }}
        continue-on-error: true
